#define F_CPU 8000000UL

#include <avr/io.h>
#include <util/delay.h>
#include "i2cmaster.h" //Thanks to Peter Fleury for his I2C library (http://homepage.hispeed.ch/peterfleury/index.html)

static unsigned char buffer[1024] = { //Values represent the boot screen
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0, 0x40, 0xC0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x80, 0x40, 0x40, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0xFE, 0xF7, 0x01, 0x03, 0x67, 0xCF, 0x80, 0x00, 0xE0, 0x87, 0x1E, 0x38, 0xC0, 0xFE, 0x03,
  0x03, 0x33, 0xF1, 0xC0, 0xF1, 0x83, 0x03, 0xEC, 0xF0, 0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x1F, 0xC7, 0x80, 0x81, 0x13, 0xAD, 0x82, 0x9A, 0xFD, 0xFF, 0xBC, 0xE9, 0xE3, 0xC7, 0x0C,
  0xF8, 0xC2, 0x04, 0xFF, 0xCF, 0xFF, 0xFE, 0xF8, 0x3B, 0x01, 0xFD, 0xFC, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x07, 0x1B, 0x7E, 0xB0, 0xC3, 0x0D, 0x39, 0x2F, 0x6F, 0xFF, 0xFF, 0xFF, 0xBC,
  0x81, 0x07, 0x18, 0x00, 0x13, 0x9F, 0xCF, 0x41, 0x40, 0x44, 0xC7, 0xCC, 0xEC, 0xEC, 0xE4, 0xCC,
  0xDC, 0x00, 0xE8, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xC0,
  0xC0, 0x40, 0x60, 0x70, 0x38, 0x14, 0x4E, 0x43, 0xE3, 0x33, 0x1A, 0x48, 0xEB, 0xEB, 0xFB, 0xF3,
  0xC3, 0xD0, 0x80, 0x07, 0x1F, 0x3B, 0xB9, 0xB9, 0x99, 0x9D, 0xBC, 0xFF, 0x6F, 0xFF, 0xCE, 0x86,
  0x86, 0xDE, 0x40, 0x1E, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x74, 0x06, 0xE7, 0xE1, 0xF3, 0xF9,
  0xF8, 0xFC, 0xE6, 0xFC, 0xFC, 0xFE, 0xFE, 0xE7, 0xF7, 0xFF, 0xFF, 0xFF, 0xFF, 0xF9, 0xFF, 0xFF,
  0x7F, 0x3E, 0xFF, 0xFE, 0xF7, 0xFF, 0xFF, 0x3F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xA7, 0xB3, 0xB3,
  0xF3, 0x31, 0x00, 0x96, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x0E, 0x1C, 0x19, 0x19, 0x1B, 0x1B,
  0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x13, 0x37, 0x37, 0x37, 0x27, 0x23, 0x33, 0x13,
  0x13, 0x03, 0x1B, 0x0B, 0x03, 0x37, 0x37, 0x26, 0x26, 0x26, 0x26, 0x27, 0x27, 0x23, 0x32, 0x18,
  0x08, 0x0C, 0x05, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

void OLED_Start(void) { //Basically an I2C layer
  i2c_start_wait(0x78+I2C_WRITE); //0x78 is the I2C address of OLED display
}

void OLED_Stop(void) {
  i2c_stop();
}

void OLED_Write(uint8_t data) {
  i2c_write(data);
}

void OLED_Command(uint8_t command) { //Function for sending a normal command
  OLED_Start();
  OLED_Write(0x00);
  OLED_Write(command);
  OLED_Stop();
}

void OLED_Init(void) {
  DDRC |= (1<<4); //Reset of OLED
  PORTC |= (1<<4);
  _delay_ms(1);
  PORTC &= ~(1<<4);
  _delay_ms(10);
  PORTC |= (1<<4);

  i2c_init(); //Initialization for the I2C Bus

  OLED_Command(0xAE); //Initialization sequenze for OLED
  OLED_Command(0xD5);
  OLED_Command(0x80);
  OLED_Command(0xA8);
  OLED_Command(0x3F);
  OLED_Command(0xD3);
  OLED_Command(0x0);
  OLED_Command(0x40 | 0x0);
  OLED_Command(0x8D);
  OLED_Command(0x14);
  OLED_Command(0x20);
  OLED_Command(0x00);
  OLED_Command(0xA0 | 0x1);
  OLED_Command(0xC8);
  OLED_Command(0xDA);
  OLED_Command(0x12);
  OLED_Command(0x81);
  OLED_Command(0xCF);
  OLED_Command(0xD9);
  OLED_Command(0xF1);
  OLED_Command(0xDB);
  OLED_Command(0x40);
  OLED_Command(0xA4);
  OLED_Command(0xA6);
  OLED_Command(0xAF);
}

void OLED_on(void) {
  OLED_Command(0xAF);
}

void OLED_off(void) {
  OLED_Command(0xAE);
}

void OLED_set_pixel(unsigned char x, unsigned char y, char state) { //Koordinaten von 0 bis x / y - 1
  if (x > 127 || y > 63)
    return;

  y=63-y;
  x=127-x;
  switch (state) {
    case 0: buffer[x+ (y/8)*128] &= ~(1 << (y&7)); return; //Pixel off
    case 1: buffer[x+ (y/8)*128] |=  (1 << (y&7)); return; //Pixel on
  }
}

void OLED_clear(void) {
  unsigned int i;
  for (i=0; i<1024; ++i)
    buffer[i] = 0;
}

void OLED_display(void) {
  unsigned int i;
  unsigned char x;

  OLED_Command(0x21);
  OLED_Command(0);
  OLED_Command(127);
  OLED_Command(0x22);
  OLED_Command(0);
  OLED_Command(7);

  for (i=0; i<1024; ++i) {
    OLED_Start();
    OLED_Write(0x40);
    for (x=0; x<16; ++x, ++i)
      OLED_Write(buffer[i]);
    --i;
    OLED_Stop();
  }
}
